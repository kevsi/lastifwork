{% extends 'base.html.twig' %}

{% block title %}Liste des Catégories{% endblock %}

{% block body %}
    {% include "aside.html.twig" %}
    <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
        <!-- Navbar -->
        {% include "navbar.html.twig" %}
        <!-- End Navbar -->
        <div class="container-fluid py-4">
            <div class="row">
                <div class="col-12">
                    <div class="card my-4">
                        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                            <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
                                <div class="d-flex justify-content-between align-items-center px-3">
                                    <div class="d-flex align-items-center ps-3">
                                        <h6 class="text-white text-capitalize mb-0">Liste des Catégories</h6>
                                        <span class="badge bg-gradient-success ms-3">{{ categories|length }} catégories</span>
                                    </div>
                                    <a href="{{ path('app_categories_create') }}" class="btn btn-sm bg-gradient-dark mb-0 px-2">
                                        <i class="material-symbols-rounded text-sm">add</i>&nbsp;&nbsp;Nouvelle catégorie
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body px-0 pb-2">
                            <div class="table-responsive p-0">
                                <table class="table align-items-center mb-0">
                                    <thead>
                                        <tr>
                                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Catégorie</th>
                                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Description</th>
                                            <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Date de création</th>
                                            <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                                            <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Fichiers</th>
                                            <th class="text-secondary opacity-7"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category in categories %}
                                            <tr>
                                                <td>
                                                    <div class="d-flex px-2 py-1">
                                                        <div class="icon icon-shape icon-sm shadow border-radius-md me-2 d-flex align-items-center justify-content-center"
                                                             style="background-color: {% if category.color is defined and category.color %}{{ category.color }}{% else %}#757575{% endif %}">
                                                            {% if category.icon is defined and category.icon %}
                                                                <i class="material-symbols-rounded text-white opacity-10">
                                                                    {{ category.icon }}
                                                                </i>
                                                            {% endif %}
                                                        </div>
                                                        <div class="d-flex flex-column justify-content-center">
                                                            <h6 class="mb-0 text-sm">{{ category.name }}</h6>
                                                            <p class="text-xs text-secondary mb-0">
                                                                ID: {{ category.id }}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <p class="text-xs font-weight-bold mb-0">
                                                        {{ category.description }}
                                                    </p>
                                                </td>
                                                <td class="align-middle text-center">
                                                    <span class="text-secondary text-xs font-weight-bold">
                                                        {{ category.createdAt|date('d F Y') }}
                                                    </span>
                                                </td>
                                                <td class="align-middle text-center text-sm">
                                                    <span class="badge badge-sm {% if category.status == 'active' %}bg-gradient-success{% elseif category.status == 'archived' %}bg-gradient-warning{% else %}bg-gradient-info{% endif %}">
                                                        {{ category.status == 'inactive' ? 'Inactif' : (category.status == 'archived' ? 'Archivé' : 'Actif') }}
                                                    </span>
                                                </td>
                                                <td class="align-middle text-center">
                                                    <div class="d-flex justify-content-center align-items-center">
                                                        <span class="me-2 text-xs font-weight-bold">{{ filesCounts[category.id] }}</span>
                                                        <div>
                                                            <!--<a href="" class="btn btn-link text-dark mb-0 p-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Voir les fichiers">
                                                                <i class="material-symbols-rounded text-sm position-relative">visibility</i>
                                                            </a>-->
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="align-middle">
                                                    <div class="d-flex align-items-center">
                                                        <!-- Lien modifier -->
                                                        <a href="{{ path('app_category_edit', {'id': category.id}) }}"
                                                           class="text-secondary font-weight-bold text-xs me-3"
                                                           data-bs-toggle="tooltip" data-bs-placement="top"
                                                           title="Modifier la catégorie">
                                                            <i class="material-symbols-rounded text-sm">edit</i>
                                                        </a>

                                                        <!-- Suppression avec alignement parfait -->
                                                        <form method="post"
                                                              action="{{ path('app_category_delete', {'id': category.id}) }}"
                                                              class="m-0 p-0"
                                                              style="display: inline"
                                                              onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette catégorie ?');">

                                                            <input type="hidden" name="_token" value="{{ csrf_token('delete-category-' ~ category.id) }}">

                                                            <button type="submit"
                                                                    class="btn p-0 m-0 border-0 bg-transparent text-danger font-weight-bold text-xs d-flex align-items-center"
                                                                    style="line-height: 1;"
                                                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                                                    title="Supprimer la catégorie">
                                                                <i class="material-symbols-rounded text-sm">delete</i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>


                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="6" class="py-4 text-center">
                                                    <p class="text-sm mb-0">Aucune catégorie trouvée</p>

                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% if categories|length > 0 %}
                        <div class="card-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-sm text-secondary">
                                    Affichage de <strong>{{ pagination.start|default(1) }}-{{ pagination.end|default(categories|length) }}</strong> sur <strong>{{ pagination.total|default(categories|length) }}</strong> catégories
                                </div>
                                {% if pagination is defined and pagination.pages > 1 %}
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-end mb-0">
                                        <li class="page-item {{ pagination.current == 1 ? 'disabled' : '' }}">
                                            <a class="page-link" href="{{ path('app_categories', {'page': pagination.current-1}) }}" tabindex="-1" {{ pagination.current == 1 ? 'aria-disabled="true"' : '' }}>
                                                <span aria-hidden="true"><i class="material-symbols-rounded text-sm">keyboard_arrow_left</i></span>
                                            </a>
                                        </li>
                                        {% for i in 1..pagination.pages %}
                                            <li class="page-item {{ pagination.current == i ? 'active' : '' }}">
                                                <a class="page-link" href="{{ path('app_categories_index', {'page': i}) }}">{{ i }}</a>
                                            </li>
                                        {% endfor %}
                                        <li class="page-item {{ pagination.current == pagination.pages ? 'disabled' : '' }}">
                                            <a class="page-link" href="{{ path('app_categories_index', {'page': pagination.current+1}) }}">
                                                <span aria-hidden="true"><i class="material-symbols-rounded text-sm">keyboard_arrow_right</i></span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Filters and search section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header p-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="mb-0">Filtres et recherche</h5>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <form action="{{ path('app_categories') }}" method="GET">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="input-group input-group-outline">
                                            <label class="form-label" for="search">Rechercher par nom...</label>
                                            <input type="text" id="search" name="search" class="form-control" value="{{ app.request.query.get('search') }}">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select border p-2 px-3 rounded" name="status">
                                            <option value="" {{ app.request.query.get('status') is empty ? 'selected' : '' }}>Tous les statuts</option>
                                            {% for status in statusOptions %}
                                                <option value="{{ status.value }}" {{ app.request.query.get('status') == status.value ? 'selected' : '' }}>
                                                    {{ status.label() }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="submit" class="btn bg-gradient-info w-100">Filtrer</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mt-4">
                <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
                    <div class="card">
                        <div class="card-header p-3 pt-2">
                            <div class="icon icon-lg icon-shape bg-gradient-primary shadow-primary text-center border-radius-xl mt-n4 position-absolute">
                                <i class="material-symbols-rounded opacity-10">folder</i>
                            </div>
                            <div class="text-end pt-1">
                                <p class="text-sm mb-0 text-capitalize">Total catégories</p>
                                <h4 class="mb-0">{{ stats.total|default(categories|length) }}</h4>
                            </div>
                        </div>
                        <hr class="dark horizontal my-0">
                        <div class="card-footer p-3">
                            <p class="mb-0"><span class="text-success text-sm font-weight-bolder">+{{ stats.monthly_new|default(0) }} </span>ce mois</p>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
                    <div class="card">
                        <div class="card-header p-3 pt-2">
                            <div class="icon icon-lg icon-shape bg-gradient-success shadow-success text-center border-radius-xl mt-n4 position-absolute">
                                <i class="material-symbols-rounded opacity-10">check_circle</i>
                            </div>
                            <div class="text-end pt-1">
                                <p class="text-sm mb-0 text-capitalize">Catégories actives</p>
                                <h4 class="mb-0">{{ stats.active|default(0) }}</h4>
                            </div>
                        </div>
                        <hr class="dark horizontal my-0">
                        <div class="card-footer p-3">
                            <p class="mb-0"><span class="text-success text-sm font-weight-bolder">{{ stats.active_percent|default(0) }}% </span>que le mois dernier</p>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
                    <div class="card">
                        <div class="card-header p-3 pt-2">
                            <div class="icon icon-lg icon-shape bg-gradient-warning shadow-warning text-center border-radius-xl mt-n4 position-absolute">
                                <i class="material-symbols-rounded opacity-10">pending</i>
                            </div>
                            <div class="text-end pt-1">
                                <p class="text-sm mb-0 text-capitalize">En attente</p>
                                <h4 class="mb-0">{{ stats.pending|default(0) }}</h4>
                            </div>
                        </div>
                        <hr class="dark horizontal my-0">
                        <div class="card-footer p-3">
                            <p class="mb-0"><span class="{{ stats.pending_percent|default(0) < 0 ? 'text-danger' : 'text-success' }} text-sm font-weight-bolder">{{ stats.pending_percent|default(0) }}% </span>cette semaine</p>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6">
                    <div class="card">
                        <div class="card-header p-3 pt-2">
                            <div class="icon icon-lg icon-shape bg-gradient-info shadow-info text-center border-radius-xl mt-n4 position-absolute">
                                <i class="material-symbols-rounded opacity-10">description</i>
                            </div>
                            <div class="text-end pt-1">
                                <p class="text-sm mb-0 text-capitalize">Total fichiers</p>
                                <h4 class="mb-0">{{ stats.files|default(0) }}</h4>
                            </div>
                        </div>
                        <hr class="dark horizontal my-0">
                        <div class="card-footer p-3">
                            <p class="mb-0"><span class="text-success text-sm font-weight-bolder">+{{ stats.files_today|default(0) }} </span>aujourd'hui</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent activity timeline -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header p-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="mb-0">Activité récente</h5>
                                </div>
                                <div class="col-md-6 text-end">
                                    <a href="" class="btn btn-outline-primary btn-sm">Voir toutes les activités</a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <div class="timeline timeline-one-side">
                                {% for activity in activities|default([]) %}
                                    <div class="timeline-block mb-3">
                                        <span class="timeline-step">
                                            <i class="material-symbols-rounded text-{{ activity.type == 'create' ? 'success' : (activity.type == 'edit' ? 'warning' : 'info') }} text-gradient">
                                                {{ activity.type == 'create' ? 'add' : (activity.type == 'edit' ? 'edit' : 'file_upload') }}
                                            </i>
                                        </span>
                                        <div class="timeline-content">
                                            <h6 class="text-dark text-sm font-weight-bold mb-0">{{ activity.description }}</h6>
                                            <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">{{ activity.createdAt|date('d F Y') }}</p>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="text-center py-3">
                                        <p class="text-secondary mb-0">Aucune activité récente</p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Fixed floating action button -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <a href="{{ path('app_categories_create') }}" class="btn btn-fab btn-fab-mini btn-primary shadow-lg">
            <i class="material-symbols-rounded">add</i>
        </a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (navigator.platform.indexOf('Win') > -1 && document.querySelector('#sidenav-scrollbar')) {
                const options = {
                    damping: '0.5'
                };
                Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
            }

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
{% endblock %}
